import sqlite3
import pandas as pd
import os
import datetime as dt

# Initial connection to SQLite3 Database
try:
    directory = os.path.dirname(os.path.realpath(__file__))
    print("----------")
    conn = sqlite3.connect(f"{directory}/BlondiesGram.db") # Directory containing all files (please keep them all in same folder.)
    cur = conn.cursor()

    print("WELCOME TO BlondiesGram")
    userlist = pd.read_sql_query("SELECT username, screename FROM UsersTable", conn)
    logged = bool(False)

except Exception as excconn:

    print(f"Could not connect to database... Error message: {excconn}")

def f_login():
    try:
        directory = os.path.dirname(os.path.realpath(__file__))
        print("----------")
        print("Log in...")
        usernamelogin = input("Username to log in: ")
        passwordlogin = input("Password to log in: ")

        check = pd.read_sql_query(f'SELECT Count(username) from UsersTable WHERE username = "{usernamelogin}" AND password = "{passwordlogin}"', conn)
        stringcheck = str(check)
        if stringcheck != '   Count(username)\n0                0':
            print(f"{usernamelogin} logged in succesfully!")
            logged = bool(True)
            
            print("----------")
            print("Starting chat log... '/help' \n")

            while logged == True: # Chat log system + commands
                msg = str(input(f"[{usernamelogin}]: "))
                date = dt.datetime.now()
                if msg == "/help": # CMD HELP
                    print("[System]: type / followed by 'logoff'")
                if msg == "/logoff": # CMD LOGOFF
                    logged = bool(False)
            
            # log register write

                with open(f"{directory}/chatlog.txt", 'a', encoding="utf-8") as chatlog:
                    chatlog.write(f"[{usernamelogin}]: {msg} [at {date}]\n")       


        else:
            print("----------")
            print("Invalid credentials... Please register or try again.")
            f_login()
      
    except Exception as excli:
        print(f"Could not log in... Error message: {excli}")
        f_login()
        logged = bool(False)


if logged == False:
    f_login()


conn.close # Ending connection to BlondiesGram ><
print("----------")
print("Connection has ended...\n")